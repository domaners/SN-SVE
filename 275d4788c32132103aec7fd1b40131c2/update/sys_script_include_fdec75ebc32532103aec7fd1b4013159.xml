<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_899160_sve.ScheduledUtils</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>ScheduledUtils</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var ScheduledUtils = Class.create();
ScheduledUtils.prototype = {

    mappedCIArr: [],

    initialize: function() {},

    scanRegisteredApps: function() {

        var regAppGr = new GlideRecord("x_899160_sve_registered_app");
        regAppGr.addQuery("active", true);
        regAppGr.query();

        while (regAppGr.next()) {

            if (regAppGr.ci_retrieval_method == "assoc") {
                this.retrieveMappedCIsAssoc(regAppGr);
            } else if (regAppGr.ci_retrieval_method == "traverse") {
                this.retrieveMappedCIsTraverse(regAppGr);
            }

            gs.info("AND obj count " + this.mappedCIArr.length + ":\n\n" + JSON.stringify(this.mappedCIArr));
            this.createOrUpdateMappedCIs();

            regAppGr.last_scan = new GlideDateTime();
            regAppGr.update();
        }

    },

    scheduledSVEScan: function() {
        var registeredAppGr = new GlideRecord("x_899160_sve_registered_app");
        registeredAppGr.addQuery("active", true);
        registeredAppGr.query();

        while (registeredAppGr.next()) {
            this.sveBlueprintScan(registeredAppGr);
            registeredAppGr.blueprints_last_evaluated = new GlideDateTime();
            registeredAppGr.update();
        }
    },

    sveBlueprintScan: function(registeredAppGr) {

        var blueprintId = registeredAppGr.blueprint + '';

        var relDefinitionsGr = new GlideRecord("x_899160_sve_relationship_definition");
        relDefinitionsGr.addQuery("blueprint", blueprintId);
        relDefinitionsGr.addQuery("active", true);
        relDefinitionsGr.query();

        while (relDefinitionsGr.next())
            this.relationshipScan(relDefinitionsGr, registeredAppGr);

    },

    relationshipScan: function(relDefinitionsGr, registeredAppGr) {

        var ciList = [];
        var excludedCIClasses = gs.getProperty("x_899160_sve.excluded_ci_classes");

        var mappedCIGr = new GlideRecord("x_899160_sve_mapped_ci");
        mappedCIGr.addQuery("active", true);
        mappedCIGr.addQuery("registered_app", registeredAppGr.sys_id + '');

        if (relDefinitionsGr.include_child_classes_parent == true)
            mappedCIGr.addQuery("ci.sys_class_name", "LIKE", relDefinitionsGr.parent_ci_class.name);
        else
            mappedCIGr.addQuery("ci.sys_class_name", relDefinitionsGr.parent_ci_class.name);
        mappedCIGr.addQuery("ci.sys_class_name", "NOT IN", excludedCIClasses);
        mappedCIGr.query();

        var cisOfDefinedChildClass = 0,
            cisOfUndefinedChildClass = 0;
        var passBlueprintCheck = "fail";

        while (mappedCIGr.next()) {

            passBlueprintCheck = "fail";

            var ciRelsGr = new GlideRecord("cmdb_rel_ci");
            ciRelsGr.addQuery("parent", mappedCIGr.ci + '');
            ciRelsGr.query();

            while (ciRelsGr.next()) {
                if (ciRelsGr.child.sys_class_name == relDefinitionsGr.child_ci_class.name + '')
                    ++cisOfDefinedChildClass;
                else
					++cisOfUndefinedChildClass;
            }

            if (relDefinitionsGr.pass_criteria == "single_ci" && cisOfDefinedChildClass > 0)
                passBlueprintCheck = "pass";
            else if (relDefinitionsGr.pass_criteria == "all_cis" && cisOfDefinedChildClass > 0 && cisOfUndefinedChildClass == 0)
                passBlueprintCheck = "pass";

            this.generateValidationResult(mappedCIGr, relDefinitionsGr, cisOfDefinedChildClass, cisOfUndefinedChildClass, passBlueprintCheck, registeredAppGr);

			if(passBlueprintCheck == "fail" && relDefinitionsGr.create_tasks == true)
				this.generateRemediationTasks(mappedCIGr, relDefinitionsGr);

			mappedCIGr.last_validated = new GlideDateTime();
			mappedCIGr.update();
        }

    },

	generateRemediationTasks: function(mappedCIGr, relDefinitionsGr) {
		
		var createTask = false;
		var remediationTaskTable = gs.getProperty("remediation_task_table");
		var defaultTaskAssignmentGroup = gs.getProperty("x_899160_sve.default_task_assignment_group");

		if(remediationTaskTable == "")
			remediationTaskTable = "task";
		
		var affectedCIGr = new GlideAggregate("task_ci");
		affectedCIGr.addQuery("task.active", true);
		affectedCIGr.addQuery("task.sys_class_name", remediationTaskTable);
		affectedCIGr.addQuery("ci_item", mappedCIGr.ci+'');
		affectedCIGr.addAggregate("COUNT");
		affectedCIGr.query();
		affectedCIGr.next();
		if(affectedCIGr.getAggregate("COUNT") == 0)
			createTask = true;

		if(createTask) {
			var remTaskGr = new GlideRecord(remediationTaskTable);
			remTaskGr.initialize();
			remTaskGr.short_description = "SVE Remediation: " + relDefinitionsGr.getDisplayValue("blueprint") + " - " + relDefinitionsGr.getDisplayValue("parent_ci_class");
			remTaskGr.description = "SVE Remediation: " + relDefinitionsGr.getDisplayValue("blueprint") + " - " + relDefinitionsGr.getDisplayValue("parent_ci_class");
			remTaskGr.assignment_group = defaultTaskAssignmentGroup; // STUB: Needs proper assignment
			var taskID = remTaskGr.insert();

			var taskCI = new GlideRecord("task_ci");
			taskCI.initialize();
			taskCI.ci_item = mappedCIGr.ci+'';
			taskCI.task = taskID;
			taskCI.insert();

			var impactedService = new GlideRecord("task_cmdb_ci_service");
			impactedService.initialize();
			impactedService.task = taskID;
			impactedService.cmdb_ci_service = mappedCIGr.service_instance+'';
			impactedService.insert();
		}
	},

	generateValidationResult: function(mappedCIGr, relDefinitionsGr, cisOfDefinedChildClass, cisOfUndefinedChildClass, passBlueprintCheck, registeredAppGr) {

		var resultGr = new GlideRecord("x_899160_sve_validation_result");
		resultGr.initialize();
		resultGr.date = new GlideDate();
		resultGr.registered_app = registeredAppGr.sys_id+'';
		resultGr.mapped_ci = mappedCIGr.sys_id+'';
		resultGr.result = passBlueprintCheck;
		resultGr.relationship_definition = relDefinitionsGr.sys_id+'';
		resultGr.compliant_cis_found = cisOfDefinedChildClass;
		resultGr.non_compliant_cis_found = cisOfUndefinedChildClass;
		resultGr.insert();

	},

    retrieveMappedCIsAssoc: function(regApp) {

        var excludedCIClasses = gs.getProperty("x_899160_sve.excluded_ci_classes");
        var inScopeOperationalStates = gs.getProperty("x_899160_sve.in_scope_operational_states");
        var lastDiscovered = new GlideDateTime();
        this.mappedCIArr = [];

        var assocGr = new GlideRecord("svc_ci_assoc");
        assocGr.addQuery("ci_id.sys_class_name", "NOT IN", excludedCIClasses);
        assocGr.addQuery("service_id", regApp.service_instance + '');
        assocGr.query();

		gs.info("AND Assocs retrieved: " + assocGr.getRowCount());

        while (assocGr.next()) {
            this.mappedCIArr.push({
                "ci": assocGr.ci_id + '',
                "service_instance": regApp.service_instance + '',
                "registered_app": regApp.sys_id + '',
                "depth": 1,
                "active": inScopeOperationalStates.indexOf(assocGr.ci_id.operational_status.toString()) > -1,
                "last_discovered": lastDiscovered
            });
        }

		gs.info("AND Mapped CI Array: " + this.mappedCIArr.length);

    },

    retrieveMappedCIsTraverse: function(regApp) {
        gs.info("Retrieve apps via traverse" + regApp.getDisplayValue("service_instance"));
    },

    createOrUpdateMappedCIs: function() {

        for (var mKey in this.mappedCIArr) {

            var mappedCIGr = new GlideRecord("x_899160_sve_mapped_ci");
            mappedCIGr.addQuery("ci", this.mappedCIArr[mKey].ci);
            mappedCIGr.addQuery("registered_app", this.mappedCIArr[mKey].registered_app);
            mappedCIGr.query();

            if (mappedCIGr.next()) {
                mappedCIGr.active = this.mappedCIArr[mKey].active;
                mappedCIGr.last_discovered = this.mappedCIArr[mKey].last_discovered + '';
                mappedCIGr.depth = this.mappedCIArr[mKey].depth + '';
                mappedCIGr.update();
            } else {
                mappedCIGr.initialize();
                mappedCIGr.ci = this.mappedCIArr[mKey].ci;
                mappedCIGr.service_instance = this.mappedCIArr[mKey].service_instance;
                mappedCIGr.registered_app = this.mappedCIArr[mKey].registered_app;
                mappedCIGr.depth = this.mappedCIArr[mKey].depth;
                mappedCIGr.active = this.mappedCIArr[mKey].active;
                mappedCIGr.last_discovered = this.mappedCIArr[mKey].last_discovered;
                mappedCIGr.insert();
            }


        }

    },

    type: 'ScheduledUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-07 12:40:15</sys_created_on>
        <sys_id>fdec75ebc32532103aec7fd1b4013159</sys_id>
        <sys_mod_count>10</sys_mod_count>
        <sys_name>ScheduledUtils</sys_name>
        <sys_package display_value="SVE" source="x_899160_sve">275d4788c32132103aec7fd1b40131c2</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="SVE">275d4788c32132103aec7fd1b40131c2</sys_scope>
        <sys_update_name>sys_script_include_fdec75ebc32532103aec7fd1b4013159</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-18 13:28:08</sys_updated_on>
    </sys_script_include>
</record_update>
